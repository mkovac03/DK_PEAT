
# Image Normalization Workflow

This project contains two scripts for calculating the global mean and standard deviation of satellite image bands, and for normalizing the images based on those statistics. The process is separated into two steps:

1. **Calculate Global Statistics**: Calculate the mean and standard deviation for each band across all images in a set of folders and save the statistics in a separate CSV file for each folder.
2. **Normalize Images**: Normalize the images using the calculated statistics from each folder's CSV file.

Note: The scripts process `.tif` files **only from the specified folder** and do not read files from subdirectories.

## Table of Contents
- [Installation](#installation)
- [Configuration](#configuration)
- [Usage](#usage)
  - [Step 1: Calculate Global Statistics](#step-1-calculate-global-statistics)
  - [Step 2: Normalize Images](#step-2-normalize-images)
- [Folder Structure](#folder-structure)

---

## Installation

1. **Clone the repository**:
   ```bash
   git clone https://github.com/mkovac03/DK_PEAT
   cd image-normalization
   ```

2. **Install the required dependencies**:  
   Ensure you have Python 3.7 or later installed. Install the dependencies using `pip`:

   ```bash
   pip install -r requirements.txt
   ```

3. **Required Libraries**:  
   The following Python packages are used:
   - `rasterio`
   - `numpy`
   - `pandas`
   - `tqdm`
   - `concurrent.futures`

   You can install them manually using:

   ```bash
   pip install rasterio numpy pandas tqdm
   ```

---

## Configuration

The project uses a configuration file (`config.py`) to define folder paths and other variables. This file contains the following configurable parameters:

```python
# config.py

# List of folder paths to process
folders = [
    "/path/to/folder1",
    "/path/to/folder2",
    "/path/to/folder3"
]

# Name of the subfolder where normalized images will be saved
normalized_subfolder = "normalized"

# Define the suffix for the CSV files that will store global statistics for each folder
csv_suffix = "_stats.csv"
```

### Parameters:
- **folders**: List of folder paths where your image files are stored. These paths should be absolute or relative to the script's location.
- **normalized_subfolder**: Name of the subfolder where normalized images will be saved within each folder.
- **csv_suffix**: Suffix for the CSV file that will be created for each folder to store the global mean and standard deviation for each band.

Make sure to update the `config.py` file with your desired folder paths and parameters.

---

## Usage

The process is divided into two steps:

### Step 1: Calculate Global Statistics

The `calculate_stats.py` script computes the global mean and standard deviation for each band in the `.tif` files (without looking into subfolders) within the given folder and saves the results to a separate CSV file for each folder. 

To calculate the statistics, run the following command:

```bash
python calculate_stats.py
```

This script will:
- Read the folder paths from `config.py`.
- Calculate the mean and standard deviation for each band in all `.tif` files directly inside each folder.
- Save the statistics (folder path, band, mean, and std) to a CSV file in the format `folder_path_stats.csv`.

### Step 2: Normalize Images

The `normalize_images.py` script normalizes the images based on the global statistics saved in each folder's respective CSV file.

To normalize the images, run the following command:

```bash
python normalize_images.py
```

This script will:
- Read the folder paths and the saved statistics from each folder's CSV file (e.g., `folder1_stats.csv`).
- Normalize each `.tif` image using the corresponding mean and standard deviation for each band.
- Save the normalized images in a subfolder (`normalized`) within the original folder.

---

## Folder Structure

Here’s an example of what your folder structure should look like:

```
├── calculate_stats.py
├── normalize_images.py
├── config.py
├── /media/lkm413/storage3/DK_PEAT/images/
│   ├── Planet/DK/clipped_images/
│   │   ├── image1.tif
│   │   ├── image2.tif
│   │   ├── clipped_images_stats.csv    # Generated by calculate_stats.py
│   │   └── normalized/                 # Normalized images will be saved here
│   ├── S1/
│   │   ├── image1.tif
│   │   ├── image2.tif
│   │   ├── S1_stats.csv                # Generated by calculate_stats.py
│   │   └── normalized/                 # Normalized images will be saved here
│   └── S2/
│       ├── image1.tif
│       ├── image2.tif
│       ├── S2_stats.csv                # Generated by calculate_stats.py
│       └── normalized/                 # Normalized images will be saved here
```

- Each folder contains `.tif` files directly in the folder (no subfolders are processed).
- The `*_stats.csv` files store the global mean and standard deviation for each band.
- Normalized images will be stored in the `normalized` subfolder created by the scripts.

---

### Notes:
- **No Subfolder Processing**: Only `.tif` files directly inside the specified folders are processed. Subdirectories are ignored.
- **Folder Permissions**: Ensure you have appropriate read/write permissions for the folders where images are stored and where results will be saved.
- **Parallel Processing**: The scripts use multithreading to speed up the computation and normalization of large datasets.
```

